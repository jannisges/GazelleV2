{% extends "base.html" %}

{% block title %}Create Device - DMX Lighting Control{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-plus-circle"></i> Create/Edit Device</h5>
            </div>
            <div class="card-body">
                <form id="deviceForm" action="/api/save-device" method="POST">
                    <input type="hidden" id="deviceId" name="device_id">
                    
                    <div class="mb-3">
                        <label for="deviceName" class="form-label">Device Name</label>
                        <input type="text" class="form-control" id="deviceName" name="name" required 
                               placeholder="e.g., RGB Par Can, Moving Head, etc.">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Shape</label>
                            <input type="hidden" id="deviceShape" name="shape" value="circle">
                            <div class="shape-selector">
                                <button type="button" class="shape-btn active" data-shape="circle" onclick="selectShape('circle')">
                                    <div class="shape-preview circle"></div>
                                    <span>Circle</span>
                                </button>
                                <button type="button" class="shape-btn" data-shape="square" onclick="selectShape('square')">
                                    <div class="shape-preview square"></div>
                                    <span>Square</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="deviceColor" class="form-label">Outline Color</label>
                            <input type="color" class="form-control form-control-color" id="deviceColor" 
                                   name="color" value="#ffffff" onchange="updatePreview()">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Channel Configuration</label>
                        <div class="channel-config" id="channelConfig">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>Channels</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addChannel()">
                                    <i class="bi bi-plus"></i> Add Channel
                                </button>
                            </div>
                            
                            <div id="channelList">
                                <!-- Channels will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-lightbulb"></i> Channel Types</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <ul class="list-unstyled">
                                            <li><span class="badge" style="background-color: #ffc107">Dimmer</span> Master brightness control</li>
                                            <li><span class="badge" style="background-color: #ffc107">Dimmer_fine</span> Fine dimmer control</li>
                                            <li><span class="badge" style="background-color: #dc3545">Red</span> Red color channel</li>
                                            <li><span class="badge" style="background-color: #28a745">Green</span> Green color channel</li>
                                            <li><span class="badge" style="background-color: #007bff">Blue</span> Blue color channel</li>
                                            <li><span class="badge" style="background-color: #f8f9fa; color: #000">White</span> White color channel</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-4">
                                        <ul class="list-unstyled">
                                            <li><span class="badge" style="background-color: #17a2b8">Pan</span> Horizontal movement</li>
                                            <li><span class="badge" style="background-color: #17a2b8">Pan_fine</span> Fine pan control</li>
                                            <li><span class="badge" style="background-color: #6f42c1">Tilt</span> Vertical movement</li>
                                            <li><span class="badge" style="background-color: #6f42c1">Tilt_fine</span> Fine tilt control</li>
                                            <li><span class="badge" style="background-color: #fd7e14">Gobo1</span> Gobo wheel 1</li>
                                            <li><span class="badge" style="background-color: #fd7e14">Gobo2</span> Gobo wheel 2</li>
                                            <li><span class="badge" style="background-color: #fd7e14">Gobo_rotation</span> Gobo rotation</li>
                                            <li><span class="badge" style="background-color: #fd7e14">Gobo_rotation_fine</span> Fine gobo rotation</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-4">
                                        <ul class="list-unstyled">
                                            <li><span class="badge" style="background-color: #e83e8c">Color_Wheel</span> Color wheel</li>
                                            <li><span class="badge" style="background-color: #20c997">Strobe</span> Strobe/shutter</li>
                                            <li><span class="badge" style="background-color: #795548">Prism</span> Prism effect</li>
                                            <li><span class="badge" style="background-color: #795548">Prisma_rotation</span> Prism rotation</li>
                                            <li><span class="badge" style="background-color: #9e9e9e">Frost</span> Frost/diffusion</li>
                                            <li><span class="badge" style="background-color: #607d8b">Zoom</span> Beam</li>
                                            <li><span class="badge" style="background-color: #607d8b">Zoom_fine</span> Fine zoom control</li>
                                            <li><span class="badge" style="background-color: #3f51b5">Focus</span> Beam focus</li>
                                            <li><span class="badge" style="background-color: #3f51b5">Focus_fine</span> Fine focus control</li>
                                            <li><span class="badge" style="background-color: #9c27b0">Macro</span> Preset macros</li>
                                            <li><span class="badge" style="background-color: #ff5722">Special_functions</span> Special functions</li>
                                            <li><span class="badge" style="background-color: #f44336">Reset</span> Function reset</li>
                                            <li><span class="badge" style="background-color: #6c757d">Dummy</span> Unused/reserved</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('patch') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Patch
                        </a>
                        <div>
                            {% if request.args.get('edit') %}
                            <button type="button" class="btn btn-danger me-2" onclick="deleteDevice()">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                            {% endif %}
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save Device
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-eye"></i> Device Preview</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="device-preview" id="devicePreview">
                        <div class="preview-fixture" id="previewFixture">
                            <span id="previewName">Device</span>
                        </div>
                    </div>
                </div>
                
                <div class="preview-info">
                    <h6>Channel Summary</h6>
                    <div id="channelSummary">
                        <small class="text-muted">Add channels to see summary</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="bi bi-collection"></i> Device Templates</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('rgb_par')">
                        RGB Par Can
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('rgbw_par')">
                        RGBW Par Can
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('moving_head')">
                        Moving Head
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('dimmer')">
                        Simple Dimmer
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadTemplate('strobe')">
                        Strobe Light
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.device-preview {
    width: 100%;
    height: 150px;
    background: #000;
    border: 1px solid #ccc;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.preview-fixture {
    width: 60px;
    height: 60px;
    border: 3px solid #fff;
    background: #333;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    font-weight: bold;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
}

.preview-fixture.circle {
    border-radius: 30px;
}

.preview-fixture.square {
    border-radius: 8px;
}

.shape-selector {
    display: flex;
    gap: 10px;
}

.shape-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    gap: 6px;
}

.shape-btn:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.shape-btn.active {
    border-color: #007bff;
    background-color: #e7f3ff;
}

.shape-preview {
    width: 24px;
    height: 24px;
    border: 2px solid #6c757d;
    background: #f8f9fa;
}

.shape-preview.circle {
    border-radius: 12px;
}

.shape-preview.square {
    border-radius: 3px;
}

.shape-btn span {
    font-size: 12px;
    font-weight: 500;
    color: #495057;
}

.channel-item {
    display: flex;
    align-items: center;
    margin: 10px 0;
    padding: 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
}

.channel-item label {
    flex: 1;
    margin-right: 10px;
    font-weight: 500;
}

.channel-item select {
    flex: 2;
    margin-right: 10px;
}

.channel-item .btn-sm {
    flex-shrink: 0;
}

</style>
{% endblock %}

{% block scripts %}
<script>
    let channelCount = 0;
    let deviceChannels = [];
    let currentDeviceId = null;
    
    // Channel type templates
    const deviceTemplates = {
        'rgb_par': {
            name: 'RGB Par Can',
            channels: [
                { type: 'dimmer_channel', name: 'Dimmer' },
                { type: 'red_channel', name: 'Red' },
                { type: 'green_channel', name: 'Green' },
                { type: 'blue_channel', name: 'Blue' }
            ]
        },
        'rgbw_par': {
            name: 'RGBW Par Can',
            channels: [
                { type: 'dimmer_channel', name: 'Dimmer' },
                { type: 'red_channel', name: 'Red' },
                { type: 'green_channel', name: 'Green' },
                { type: 'blue_channel', name: 'Blue' },
                { type: 'white_channel', name: 'White' }
            ]
        },
        'moving_head': {
            name: 'Moving Head',
            channels: [
                { type: 'dimmer_channel', name: 'Dimmer' },
                { type: 'red_channel', name: 'Red' },
                { type: 'green_channel', name: 'Green' },
                { type: 'blue_channel', name: 'Blue' },
                { type: 'pan', name: 'Pan' },
                { type: 'tilt', name: 'Tilt' },
                { type: 'gobo1', name: 'Gobo' },
                { type: 'strobe', name: 'Strobe' }
            ]
        },
        'dimmer': {
            name: 'Simple Dimmer',
            channels: [
                { type: 'dimmer_channel', name: 'Dimmer' }
            ]
        },
        'strobe': {
            name: 'Strobe Light',
            channels: [
                { type: 'dimmer_channel', name: 'Brightness' },
                { type: 'strobe', name: 'Strobe Rate' }
            ]
        }
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        // Check if editing existing device
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit');
        
        if (editId) {
            loadDevice(editId);
        } else {
            // Start with one channel
            addChannel();
        }
        
        setupFormSubmission();
    });
    
    function addChannel() {
        channelCount++;
        const channelDiv = document.createElement('div');
        channelDiv.className = 'channel-item';
        channelDiv.dataset.channelId = channelCount;
        
        channelDiv.innerHTML = `
            <label>Channel ${channelCount}:</label>
            <select class="form-select" name="channel_${channelCount}_type" onchange="updatePreview()">
                <option value="dimmer_channel">Dimmer</option>
                <option value="dimmer_fine">Dimmer_fine</option>
                <option value="red_channel">Red</option>
                <option value="green_channel">Green</option>
                <option value="blue_channel">Blue</option>
                <option value="white_channel">White</option>
                <option value="pan">Pan</option>
                <option value="pan_fine">Pan_fine</option>
                <option value="tilt">Tilt</option>
                <option value="tilt_fine">Tilt_fine</option>
                <option value="gobo1">Gobo1</option>
                <option value="gobo2">Gobo2</option>
                <option value="gobo_rotation">Gobo_rotation</option>
                <option value="gobo_rotation_fine">Gobo_rotation_fine</option>
                <option value="color_wheel">Color_Wheel</option>
                <option value="strobe">Strobe</option>
                <option value="prism">Prism</option>
                <option value="prisma_rotation">Prisma_rotation</option>
                <option value="frost">Frost</option>
                <option value="zoom">Zoom</option>
                <option value="zoom_fine">Zoom_fine</option>
                <option value="focus">Focus</option>
                <option value="focus_fine">Focus_fine</option>
                <option value="macro">Macro</option>
                <option value="special_functions">Special_functions</option>
                <option value="reset">Reset</option>
                <option value="dummy">Dummy/Other</option>
            </select>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeChannel(${channelCount})">
                <i class="bi bi-trash"></i>
            </button>
        `;
        
        document.getElementById('channelList').appendChild(channelDiv);
        updatePreview();
    }
    
    function removeChannel(channelId) {
        const channelDiv = document.querySelector(`[data-channel-id="${channelId}"]`);
        if (channelDiv) {
            channelDiv.remove();
            updateChannelNumbers();
            updatePreview();
        }
    }
    
    function updateChannelNumbers() {
        const channels = document.querySelectorAll('.channel-item');
        channels.forEach((channel, index) => {
            const label = channel.querySelector('label');
            label.textContent = `Channel ${index + 1}:`;
            
            const select = channel.querySelector('select');
            select.name = `channel_${index + 1}_type`;
        });
        
        channelCount = channels.length;
    }
    
    function updatePreview() {
        const deviceName = document.getElementById('deviceName').value || 'Device';
        const deviceShape = document.getElementById('deviceShape').value || 'circle';
        const deviceColor = document.getElementById('deviceColor').value || '#ffffff';
        const channels = Array.from(document.querySelectorAll('.channel-item select')).map(select => ({
            type: select.value
        }));
        
        // Update device name
        document.getElementById('previewName').textContent = deviceName;
        
        // Update preview fixture shape and color
        const fixture = document.getElementById('previewFixture');
        fixture.className = `preview-fixture ${deviceShape}`;
        fixture.style.borderColor = deviceColor;
        fixture.style.boxShadow = `0 0 20px ${deviceColor}40`;
        
        // Update channel summary
        const summary = channels.map((ch, i) => 
            `<div class="d-flex justify-content-between">
                <span>Ch ${i + 1}:</span>
                <span class="badge" style="background-color: ${DMXUtils.getChannelTypeColor(ch.type)}">${ch.type.replace('_', ' ')}</span>
            </div>`
        ).join('');
        
        document.getElementById('channelSummary').innerHTML = summary || '<small class="text-muted">No channels configured</small>';
    }
    
    function selectShape(shape) {
        // Update hidden input
        document.getElementById('deviceShape').value = shape;
        
        // Update button states
        document.querySelectorAll('.shape-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-shape="${shape}"]`).classList.add('active');
        
        // Update preview
        updatePreview();
    }
    
    function loadTemplate(templateKey) {
        const template = deviceTemplates[templateKey];
        if (!template) return;
        
        // Set device name
        document.getElementById('deviceName').value = template.name;
        
        // Clear existing channels
        document.getElementById('channelList').innerHTML = '';
        channelCount = 0;
        
        // Add template channels
        template.channels.forEach(channel => {
            addChannel();
            const lastSelect = document.querySelector('.channel-item:last-child select');
            lastSelect.value = channel.type;
        });
        
        updatePreview();
    }
    
    function setupFormSubmission() {
        document.getElementById('deviceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const deviceName = document.getElementById('deviceName').value;
            
            if (!deviceName) {
                DMXUtils.showNotification('Please enter a device name', 'error');
                return;
            }
            
            const channels = [];
            document.querySelectorAll('.channel-item').forEach((item, index) => {
                const select = item.querySelector('select');
                channels.push({
                    type: select.value,
                    name: `Channel ${index + 1}`
                });
            });
            
            if (channels.length === 0) {
                DMXUtils.showNotification('Please add at least one channel', 'error');
                return;
            }
            
            const deviceData = {
                name: deviceName,
                channels: channels,
                shape: document.getElementById('deviceShape').value,
                color: document.getElementById('deviceColor').value
            };
            
            if (currentDeviceId) {
                deviceData.id = currentDeviceId;
            }
            
            DMXUtils.apiCall('/api/save-device', 'POST', deviceData)
            .then(response => {
                if (response.success) {
                    DMXUtils.showNotification('Device saved successfully', 'success');
                    setTimeout(() => {
                        window.location.href = '/patch';
                    }, 1000);
                } else {
                    DMXUtils.showNotification('Error saving device: ' + response.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving device:', error);
                DMXUtils.showNotification('Error saving device', 'error');
            });
        });
    }
    
    function loadDevice(deviceId) {
        currentDeviceId = deviceId;
        
        DMXUtils.apiCall(`/api/get-device/${deviceId}`)
        .then(response => {
            if (response.success) {
                const device = response.device;
                
                // Set device name
                document.getElementById('deviceName').value = device.name;
                
                // Set device shape and color
                const deviceShape = device.shape || 'circle';
                document.getElementById('deviceShape').value = deviceShape;
                document.getElementById('deviceColor').value = device.color || '#ffffff';
                
                // Update shape button selection
                document.querySelectorAll('.shape-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-shape="${deviceShape}"]`).classList.add('active');
                
                // Clear existing channels
                document.getElementById('channelList').innerHTML = '';
                channelCount = 0;
                
                // Load device channels
                const channels = JSON.parse(device.channels || '[]');
                channels.forEach(channel => {
                    addChannel();
                    const lastSelect = document.querySelector('.channel-item:last-child select');
                    lastSelect.value = channel.type;
                });
                
                updatePreview();
            } else {
                DMXUtils.showNotification('Error loading device: ' + response.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading device:', error);
            DMXUtils.showNotification('Error loading device', 'error');
        });
    }
    
    function deleteDevice() {
        if (!currentDeviceId) return;
        
        if (confirm('Are you sure you want to delete this device? This will also remove all patch assignments.')) {
            DMXUtils.apiCall('/api/delete-device', 'POST', { device_id: currentDeviceId })
            .then(response => {
                if (response.success) {
                    DMXUtils.showNotification('Device deleted successfully', 'success');
                    setTimeout(() => {
                        window.location.href = '/patch';
                    }, 1000);
                } else {
                    DMXUtils.showNotification('Error deleting device: ' + response.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting device:', error);
                DMXUtils.showNotification('Error deleting device', 'error');
            });
        }
    }
</script>
{% endblock %}